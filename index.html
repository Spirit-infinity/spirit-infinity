<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spirit Infinity | Global Ecosystem</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&family=Orbitron:wght@400;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-dark: #050505;
            --card-bg: #0a0a0a;
            --neon-orange: #ff6600;
            --spirit-green: #00ffaa;
            --text-main: #ffffff;
            --text-dim: #777777;
            --border-color: #1a1a1a;
            --neon-shadow: 0 0 15px rgba(255, 102, 0, 0.4);
            --danger: #ff3333;
        }

        * { box-sizing: border-box; }

        body { 
            background-color: var(--bg-dark); 
            color: var(--text-main); 
            font-family: 'Inter', sans-serif; 
            margin: 0; 
            overflow-x: hidden;
        }

        /* --- HEADER & LOGO --- */
        header { 
            padding: 20px 5%; 
            background: #000; 
            border-bottom: 3px solid var(--neon-orange); 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            position: sticky; 
            top: 0; 
            z-index: 1000;
            box-shadow: var(--neon-shadow);
        }

        .logo-container { cursor: pointer; display: flex; flex-direction: column; }
        .logo-main { 
            font-family: 'Orbitron', sans-serif; 
            font-weight: 900; 
            font-size: 2.2rem; 
            color: white; 
            line-height: 0.9;
        }
        .logo-sub { 
            font-weight: 700; 
            font-size: 0.8rem; 
            color: var(--neon-orange); 
            letter-spacing: 4px; 
            text-transform: uppercase;
        }

        nav { display: flex; gap: 20px; }
        nav button { 
            background: none; 
            border: none; 
            color: white; 
            font-weight: bold; 
            text-transform: uppercase; 
            font-size: 0.8rem; 
            cursor: pointer; 
            transition: 0.3s;
            padding: 10px;
        }
        nav button:hover, nav button.active { color: var(--neon-orange); text-shadow: 0 0 8px var(--neon-orange); }

        .btn-action { 
            background: var(--neon-orange); 
            color: black; 
            border: none; 
            padding: 14px 28px; 
            font-weight: 900; 
            cursor: pointer; 
            border-radius: 2px; 
            text-transform: uppercase; 
            font-size: 0.8rem;
            transition: 0.2s;
        }
        .btn-action:hover { background: white; transform: scale(1.05); }

        /* --- LAYOUT --- */
        .main-wrapper { display: flex; padding: 30px 5%; gap: 40px; }
        
        /* SIDEBAR FILTERS */
        .sidebar { 
            width: 320px; 
            background: var(--card-bg); 
            padding: 25px; 
            border: 1px solid var(--border-color); 
            height: fit-content; 
            position: sticky; 
            top: 120px;
            border-left: 3px solid var(--neon-orange);
        }
        .sidebar h3 { color: var(--neon-orange); font-size: 0.9rem; margin-top: 0; margin-bottom: 20px; letter-spacing: 2px; }
        
        .filter-group { margin-bottom: 25px; }
        .filter-group label { display: block; font-size: 0.7rem; color: var(--text-dim); text-transform: uppercase; margin-bottom: 8px; font-weight: bold; }
        
        select, input, textarea { 
            width: 100%; 
            background: #111; 
            border: 1px solid #222; 
            color: white; 
            padding: 12px; 
            border-radius: 0; 
            font-family: inherit;
        }
        select:focus { border-color: var(--neon-orange); outline: none; }

        /* MARKET GRID */
        .content-area { flex: 1; }
        .section-header { 
            color: var(--neon-orange); 
            font-family: 'Orbitron', sans-serif;
            font-size: 1.5rem; 
            margin: 40px 0 20px 0; 
            padding-bottom: 10px;
            border-bottom: 1px solid #222;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .section-header::before { content: ""; width: 10px; height: 10px; background: var(--neon-orange); }

        .grid-container { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); 
            gap: 30px; 
        }

        /* --- CARDS --- */
        .spirit-card { 
            background: var(--card-bg); 
            border: 1px solid var(--border-color); 
            transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
            cursor: pointer; 
            position: relative;
            overflow: hidden;
        }
        .spirit-card:hover { 
            border-color: var(--neon-orange); 
            transform: translateY(-8px); 
            box-shadow: 0 15px 30px rgba(0,0,0,0.9);
        }
        .card-img { 
            width: 100%; 
            height: 250px; 
            background: #000; 
            display: flex; 
            align-items: center; 
            justify-content: center;
            border-bottom: 1px solid #111;
            position: relative;
        }
        .card-img::after { 
            content: "SCAN IA"; 
            position: absolute; 
            bottom: 10px; 
            right: 10px; 
            font-size: 0.6rem; 
            color: var(--text-dim);
            letter-spacing: 2px;
        }
        .card-badge { 
            position: absolute; 
            top: 15px; 
            left: 15px; 
            padding: 6px 14px; 
            font-size: 0.65rem; 
            font-weight: 900; 
            z-index: 5;
            text-transform: uppercase;
        }
        .badge-native { background: var(--spirit-green); color: black; box-shadow: 0 0 10px var(--spirit-green); }
        .badge-legacy { background: #0066ff; color: white; }

        .card-body { padding: 20px; }
        .card-price { font-size: 1.8rem; font-weight: 900; margin-bottom: 5px; font-family: 'Orbitron'; }
        .card-title { font-size: 0.95rem; color: #ddd; margin-bottom: 15px; height: 40px; overflow: hidden; }
        .card-footer { 
            border-top: 1px solid #1a1a1a; 
            padding-top: 15px; 
            display: flex; 
            justify-content: space-between; 
            font-size: 0.7rem; 
            color: var(--text-dim);
        }

        /* --- FORUM --- */
        .forum-wrap { background: #080808; border: 1px solid #111; border-radius: 4px; padding: 0; overflow: hidden; }
        .forum-row { 
            display: flex; 
            padding: 25px; 
            border-bottom: 1px solid #111; 
            gap: 20px;
            transition: 0.3s;
        }
        .forum-row:hover { background: #0c0c0c; }
        .forum-stats { display: flex; flex-direction: column; align-items: center; min-width: 60px; color: var(--neon-orange); font-weight: bold; }
        .forum-main { flex: 1; }
        .forum-tag { font-size: 0.6rem; background: #222; color: #aaa; padding: 3px 8px; margin-right: 5px; }

        /* --- MODALS --- */
        .modal-overlay { 
            display: none; 
            position: fixed; 
            inset: 0; 
            background: rgba(0,0,0,0.98); 
            z-index: 9999; 
            overflow-y: auto; 
            padding: 50px 5%; 
        }
        .modal-container { 
            background: #050505; 
            border: 2px solid var(--neon-orange); 
            max-width: 1200px; 
            margin: auto; 
            position: relative;
            box-shadow: 0 0 50px rgba(255,102,0,0.2);
        }
        .modal-close { 
            position: absolute; 
            top: 20px; 
            right: 20px; 
            background: none; 
            border: none; 
            color: white; 
            font-size: 2rem; 
            cursor: pointer;
            z-index: 100;
        }

        /* --- SPECIAL EFFECTS --- */
        .scan-line { 
            position: absolute; 
            width: 100%; 
            height: 3px; 
            background: var(--neon-orange); 
            box-shadow: 0 0 20px var(--neon-orange); 
            top: 0; 
            animation: scanning 2.5s infinite ease-in-out;
        }
        @keyframes scanning {
            0% { top: 0%; }
            100% { top: 100%; }
        }

        .ledger-box { 
            border: 1px solid var(--spirit-green); 
            background: rgba(0,255,170,0.02); 
            padding: 20px; 
            font-family: monospace; 
            color: var(--spirit-green);
        }
    </style>
</head>
<body>

<header>
    <div class="logo-container" onclick="location.reload()">
        <span class="logo-main">HOT TOYS</span>
        <span class="logo-sub">Spirit Infinity</span>
    </div>
    <nav>
        <button class="active" onclick="location.reload()">Marketplace</button>
        <button onclick="openLedger()">Spirit Ledger</button>
        <button onclick="openForum()">Communité</button>
        <button onclick="openAccount()">Mon Compte</button>
        <button onclick="window.open('https://www.hottoys.com.hk/contact.php')">SAV Officiel</button>
    </nav>
    <div style="display:flex; gap:15px;">
        <button class="btn-action" style="background:#111; color:white; border:1px solid #333;" onclick="connectBase()">Connecter Base</button>
        <button class="btn-action" onclick="openCertif()">Vendre & Certifier</button>
    </div>
</header>

<div class="main-wrapper">
    <aside class="sidebar">
        <h3>CONFIGURATEUR</h3>
        
        <div class="filter-group">
            <label>Tranche de Prix</label>
            <select id="filterPrice" onchange="applyExpertFilters()">
                <option value="all">Tous les prix</option>
                <option value="0-100">0€ - 100€</option>
                <option value="100-200">100€ - 200€</option>
                <option value="200-300">200€ - 300€</option>
                <option value="300-400">300€ - 400€</option>
                <option value="400+">400€ et plus</option>
            </select>
        </div>

        <div class="filter-group">
            <label>Marque & Origine</label>
            <select id="filterBrand" onchange="applyExpertFilters()">
                <option value="all">Toutes les marques</option>
                <option value="Hot Toys">Hot Toys</option>
                <option value="InArt">InArt</option>
                <option value="Sideshow">Sideshow</option>
                <option value="Autre">Autre</option>
            </select>
        </div>

        <div class="filter-group">
            <label>Format</label>
            <select id="filterCat" onchange="applyExpertFilters()">
                <option value="all">Tout voir</option>
                <option value="1/6">Action Figure 1/6</option>
                <option value="1/4">Statue 1/4</option>
                <option value="Resine">Résine / XL</option>
            </select>
        </div>

        <div class="ledger-box" style="margin-top:40px; font-size:0.75rem;">
            > SYSTEM STATUS: ONLINE<br>
            > LEDGER PROTECTION: 3%/3%<br>
            > ZERO-TRACE: ACTIVE
        </div>
    </aside>

    <main class="content-area">
        <div class="section-header">OBJETS NATIVEMENT ÉQUIPÉS</div>
        <div class="grid-container" id="gridNative"></div>

        <div class="section-header">COLLECTIONS CERTIFIÉES PAR IA</div>
        <div class="grid-container" id="gridLegacy"></div>
    </main>
</div>

<div id="modalCertif" class="modal-overlay">
    <div class="modal-container" style="max-width:800px; padding:50px;">
        <button class="modal-close" onclick="closeAll()">✕</button>
        
        <div id="step1">
            <h2 style="font-family:'Orbitron'; text-align:center; color:var(--neon-orange);">PUBLIER UNE ANNONCE</h2>
            <div style="display:grid; grid-template-columns: 1fr; gap:15px; margin-top:30px;">
                <button class="btn-action" onclick="setMethod('native')">Hot Toys Spirit Native (Puce Ledger)</button>
                <button class="btn-action" style="background:#0066ff; color:white;" onclick="setMethod('legacy')">Hot Toys Legacy (Scan IA)</button>
                <button class="btn-action" style="background:#333; color:white;" onclick="setMethod('other')">Autre Marque (Vente Directe)</button>
            </div>
        </div>

        <div id="step2" style="display:none;">
            <h3 style="color:var(--neon-orange);">INFORMATIONS PRODUIT</h3>
            <input type="text" id="inTitle" placeholder="Titre de la figurine">
            <input type="number" id="inPrice" placeholder="Prix de vente (€)">
            
            <label style="color:var(--neon-orange); font-size:0.7rem; margin-top:20px; display:block;">TAILLE DU COLIS (LOGISTIQUE SPIRIT)</label>
            <select id="inShip">
                <option value="9.90">S - Petit (Têtes, Accessoires, Box Slim) - 9.90€</option>
                <option value="14.90">M - Moyen (Boîte 1/6 Standard) - 14.90€</option>
                <option value="25.00">L - Grand (Diecast, Hulk, 1/4, Boîte XL) - 25.00€</option>
            </select>
            
            <textarea id="inDesc" rows="4" placeholder="État détaillé..."></textarea>
            <button class="btn-action" style="width:100%; margin-top:20px;" onclick="handleNext()">CONTINUER</button>
        </div>

        <div id="stepScan" style="display:none; text-align:center;">
            <h2 style="font-family:'Orbitron';">SCAN AUTHENTIFICATION</h2>
            <div style="height:300px; background:#000; border:1px solid #222; margin:30px 0; position:relative; overflow:hidden;">
                <div class="scan-line"></div>
                <div style="position:absolute; inset:0; display:flex; align-items:center; justify-content:center; color:#222; font-weight:bold;">COMPARAISON BIOMÉTRIQUE</div>
            </div>
            <p id="scanStatus" style="color:var(--spirit-green); font-family:monospace;">Analyse de la structure moléculaire...</p>
        </div>

        <div id="stepSuccess" style="display:none; text-align:center;">
            <h2 style="color:var(--spirit-green); font-family:'Orbitron';">CERTIFICATION RÉUSSIE</h2>
            <p>L'annonce a été injectée au sommet de la Marketplace.</p>
            <button class="btn-action" style="width:100%; margin-top:30px;" onclick="finalizeSale()">RETOUR AU MARCHÉ</button>
        </div>
    </div>
</div>

<div id="modalForum" class="modal-overlay">
    <div class="modal-container" style="padding:40px;">
        <button class="modal-close" onclick="closeAll()">✕</button>
        <h2 style="font-family:'Orbitron'; margin-bottom:30px; border-bottom:2px solid var(--neon-orange); padding-bottom:10px;">COMMUNAUTÉ SPIRIT INFINITY</h2>
        <div class="forum-wrap">
            <div class="forum-row">
                <div class="forum-stats">▲<br>242<br>▼</div>
                <div class="forum-main">
                    <div style="font-size:0.7rem; color:var(--spirit-green);">[OFFICIEL] Spirit Team</div>
                    <div class="forum-title" style="font-weight:bold; font-size:1.1rem; margin:5px 0;">Mise à jour Ledger : Frais réduits à 3% pour les membres Genesis</div>
                    <div><span class="forum-tag">ANNONCE</span><span class="forum-tag">ECONOMIE</span></div>
                </div>
            </div>
            <div class="forum-row">
                <div class="forum-stats">▲<br>56<br>▼</div>
                <div class="forum-main">
                    <div style="font-size:0.7rem; color:var(--text-dim);">Posté par Collector_75 • 4h ago</div>
                    <div class="forum-title" style="font-weight:bold; font-size:1.1rem; margin:5px 0;">Comment reconnaître un faux MK85 sans le scanner ?</div>
                    <div><span class="forum-tag">AIDE</span><span class="forum-tag">HOT TOYS</span></div>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="modalProduct" class="modal-overlay">
    <div class="modal-container" style="padding:0; overflow:hidden;">
        <button class="modal-close" onclick="closeAll()">✕</button>
        <div style="display:flex; height:100vh;">
            <div style="flex:1.5; background:#000; display:flex; align-items:center; justify-content:center; border-right:1px solid #111;">
                <span style="color:#111; font-weight:900; font-size:4rem;">SPIRIT SCAN</span>
            </div>
            <div style="flex:1; padding:40px; display:flex; flex-direction:column;">
                <h1 id="pTitle" style="font-family:'Orbitron'; font-size:2rem; margin-top:0;">Titre Produit</h1>
                <div class="ledger-box">
                    <div style="display:flex; justify-content:space-between; margin-bottom:10px;"><span>Prix de l'objet</span> <span id="pPrice">0 €</span></div>
                    <div style="display:flex; justify-content:space-between; margin-bottom:10px;"><span>Expédition (S/M/L)</span> <span id="pShip">0 €</span></div>
                    <div style="display:flex; justify-content:space-between; margin-bottom:10px;"><span>Protection Ledger (3%+3%)</span> <span id="pFees" style="color:var(--spirit-green);">0 €</span></div>
                    <hr style="border-color:#222;">
                    <div style="display:flex; justify-content:space-between; font-size:1.5rem; font-weight:bold; color:var(--neon-orange);"><span>TOTAL</span> <span id="pTotal">0 €</span></div>
                </div>

                <div id="chatBox" style="flex:1; margin-top:20px; border:1px solid #111; background:#080808; padding:15px; overflow-y:auto; font-size:0.85rem;">
                    <div style="color:var(--danger); border:1px solid var(--danger); padding:10px; font-size:0.7rem; margin-bottom:10px;">[WATCHDOG SECURITY] Tout échange de données personnelles (Tel, Mail, PayPal) entraîne le bannissement du Ledger.</div>
                </div>
                <div style="display:flex; border:1px solid #222;">
                    <input type="text" id="chatInput" placeholder="Posez une question..." style="border:none;">
                    <button class="btn-action" onclick="sendSecureMessage()">ENVOYER</button>
                </div>
                <button class="btn-action" style="width:100%; height:60px; margin-top:20px; font-size:1.2rem;">ACHETER MAINTENANT</button>
            </div>
        </div>
    </div>
</div>

<script>
    /* --- CONFIGURATIONS --- */
    const SUPABASE_URL = 'https://eagmxrbtcajqlhivvpww.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVhZ214cmJ0Y2FqcWxoaXZ2cHd3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEzMDYzMTAsImV4cCI6MjA4Njg4MjMxMH0.bkruo7GrA7UUZIv7HANG4_DFUrm9IygJP9ueVk_4r78'; // Ta clé complète ici
    const _spirit = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let items = [
        { id:1, title: "Batman InArt 1/6 (Dark Knight)", price: 890, brand: "InArt", type: "native", cat: "1/6", ship: 14.90 },
        { id:2, title: "Iron Man MK85 Hot Toys Diecast", price: 425, brand: "Hot Toys", type: "legacy", cat: "1/6", ship: 25.00 },
        { id:3, title: "Joker Rooted Hair Edition InArt", price: 1150, brand: "InArt", type: "native", cat: "1/6", ship: 14.90 }
    ];

    /* --- RENDU MARKETPLACE --- */
    function render() {
        const gridN = document.getElementById('gridNative');
        const gridL = document.getElementById('gridLegacy');
        gridN.innerHTML = ''; gridL.innerHTML = '';

        items.forEach(item => {
            const card = document.createElement('div');
            card.className = 'spirit-card';
            card.dataset.price = item.price;
            card.dataset.brand = item.brand;
            card.dataset.cat = item.cat;
            card.onclick = () => openProduct(item);
            card.innerHTML = `
                <div class="card-badge ${item.type === 'native' ? 'badge-native' : 'badge-legacy'}">
                    ${item.type === 'native' ? 'SPIRIT NATIVE' : 'IA CERTIFIED'}
                </div>
                <div class="card-img">IMAGE ${item.id}</div>
                <div class="card-body">
                    <div class="card-price">${item.price} €</div>
                    <div class="card-title">${item.title}</div>
                    <div class="card-footer">
                        <span>PORT: ${item.ship}€</span>
                        <span style="color:var(--spirit-green)">LEDGER PROTECTED</span>
                    </div>
                </div>
            `;
            if(item.type === 'native') gridN.appendChild(card);
            else gridL.appendChild(card);
        });
    }

    /* --- FILTRES EXPERTS --- */
    function applyExpertFilters() {
        const pRange = document.getElementById('filterPrice').value;
        const brand = document.getElementById('filterBrand').value;
        const cat = document.getElementById('filterCat').value;

        document.querySelectorAll('.spirit-card').forEach(card => {
            const p = parseInt(card.dataset.price);
            let matchP = true;
            if(pRange === '0-100') matchP = p <= 100;
            else if(pRange === '100-200') matchP = p > 100 && p <= 200;
            else if(pRange === '200-300') matchP = p > 200 && p <= 300;
            else if(pRange === '300-400') matchP = p > 300 && p <= 400;
            else if(pRange === '400+') matchP = p > 400;

            const matchB = (brand === 'all' || card.dataset.brand === brand);
            const matchC = (cat === 'all' || card.dataset.cat === cat);

            card.style.display = (matchP && matchB && matchC) ? 'block' : 'none';
        });
    }

    /* --- LOGIQUE DE VENTE --- */
    let sellMethod = '';
    function openCertif() { 
        document.getElementById('modalCertif').style.display = 'block'; 
        document.getElementById('step1').style.display = 'block';
        document.getElementById('step2').style.display = 'none';
        document.getElementById('stepScan').style.display = 'none';
        document.getElementById('stepSuccess').style.display = 'none';
    }

    function setMethod(m) {
        sellMethod = m;
        document.getElementById('step1').style.display = 'none';
        document.getElementById('step2').style.display = 'block';
    }

    function handleNext() {
        document.getElementById('step2').style.display = 'none';
        if(sellMethod === 'other') {
            finalizeSale(); // Pas de scan IA pour les autres marques
            return;
        }
        document.getElementById('stepScan').style.display = 'block';
        setTimeout(() => {
            document.getElementById('stepScan').style.display = 'none';
            document.getElementById('stepSuccess').style.display = 'block';
        }, 3000);
    }

    function finalizeSale() {
        const newItem = {
            id: Date.now(),
            title: document.getElementById('inTitle').value,
            price: parseInt(document.getElementById('inPrice').value),
            brand: sellMethod === 'other' ? 'Autre' : 'Hot Toys',
            type: sellMethod === 'native' ? 'native' : 'legacy',
            cat: "1/6",
            ship: parseFloat(document.getElementById('inShip').value)
        };
        items.unshift(newItem); // En tête de liste
        closeAll();
        render();
    }

    /* --- CHAT WATCHDOG --- */
    function sendSecureMessage() {
        const input = document.getElementById('chatInput');
        const box = document.getElementById('chatBox');
        if(!input.value) return;
        const msg = input.value.toLowerCase();
        
        if(msg.includes("paypal") || msg.includes("06") || msg.includes("07") || msg.includes("@")) {
            box.innerHTML += `<div style="color:var(--danger); margin-top:10px;">[BLOCKED] Tentative de contournement du Ledger détectée.</div>`;
        } else {
            box.innerHTML += `<div style="margin-top:5px;"><strong>Moi:</strong> ${input.value}</div>`;
        }
        input.value = '';
        box.scrollTop = box.scrollHeight;
    }

    /* --- WEBSERIAL ESP32 --- */
    async function connectBase() {
        try {
            const port = await navigator.serial.requestPort();
            await port.open({ baudRate: 115200 });
            alert("BASE SPIRIT CONNECTÉE AU LEDGER");
        } catch(e) {
            alert("Erreur de connexion base : " + e);
        }
    }

    /* --- HELPERS --- */
    function openProduct(item) {
        document.getElementById('modalProduct').style.display = 'block';
        document.getElementById('pTitle').innerText = item.title;
        document.getElementById('pPrice').innerText = item.price + " €";
        document.getElementById('pShip').innerText = item.ship + ".00 €";
        const fees = item.price * 0.06;
        document.getElementById('pFees').innerText = fees.toFixed(2) + " €";
        document.getElementById('pTotal').innerText = (item.price + item.ship + fees).toFixed(2) + " €";
    }

    function openForum() { document.getElementById('modalForum').style.display = 'block'; }
    function openLedger() { alert("Accès Ledger Spirit : Votre valorisation projet est estimée à 3.8M€."); }
    function openAccount() { alert("Dashboard Vendeur : Bordereaux d'expédition en attente."); }
    function closeAll() { document.querySelectorAll('.modal-overlay').forEach(m => m.style.display = 'none'); }

    render();
</script>
</body>
</html>
