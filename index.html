// Tes nouveaux identifiants Supabase (Projet eagmx...)
const SUPABASE_URL = 'https://eagmxrbtcaqqlhivvpww.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVhZ214cmJ0Y2FqcWxoaXZ2cHd3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEzMDYzMTAsImV4cCI6MjA4Njg4MjMxMH0.bkruo7GrA7UUZIv7HANG4_DFUrm9IygJP9ueVk_4r78';

// Initialisation du client Supabase
const _spirit = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// FONCTION : Synchronisation du Ledger
async function syncLedger() {
    try {
        // On récupère les données de la table 'transactions' que tu as créée (Photo n°8)
        const { data, error } = await _spirit.from('transactions').select('*');
        
        if (error) throw error;

        if (data) {
            // Calcul des montants (Royalties 3€ et Split 2.5%)
            let r = data.reduce((s, t) => s + (Number(t.spirit_royalty) || 0), 0);
            let p = data.reduce((s, t) => s + (Number(t.commission_partner_2_5_percent) || 0), 0);
            let sp = data.reduce((s, t) => s + (Number(t.commission_spirit_2_5_percent) || 0), 0);
            
            // Affichage dans ton interface (ID l-roy, l-part, l-spi de ta photo n°3)
            if(document.getElementById('l-roy')) document.getElementById('l-roy').innerText = r.toFixed(2) + " €";
            if(document.getElementById('l-part')) document.getElementById('l-part').innerText = p.toFixed(2) + " €";
            if(document.getElementById('l-spi')) document.getElementById('l-spi').innerText = sp.toFixed(2) + " €";
            
            console.log("Ledger Spirit Infinity synchronisé.");
        }
    } catch (e) {
        console.error("Erreur de connexion :", e.message);
    }
}

// FONCTION : Simuler un achat (Action du bouton)
async function simulatePayment(price) {
    if(!confirm("Confirmer la transaction sur Spirit Infinity ?")) return;
    
    const comm = price * 0.025; // Commission de 2.5%

    const { error } = await _spirit.from('transactions').insert([{ 
        price_sold: price, 
        spirit_royalty: 3.00, 
        commission_partner_2_5_percent: comm, 
        commission_spirit_2_5_percent: comm,
        status: 'COMPLETED'
    }]);

    if (error) {
        alert("Erreur Supabase : " + error.message);
    } else {
        alert("Paiement Spirit Validé !");
        syncLedger(); // Mise à jour immédiate
    }
}

// Lancement automatique
syncLedger(); 
setInterval(syncLedger, 10000); // Rafraîchissement toutes les 10 secondes

