// ==========================================
// CONFIGURATION SPIRIT INFINITY - GREFEE FINALE
// ==========================================

// 1. Initialisation avec les nouveaux identifiants (Cibles le projet eagmx...)
const SUPABASE_URL = 'https://eagmxrbtcaqqlhivvpww.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVhZ214cmJ0Y2FqcWxoaXZ2cHd3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEzMDYzMTAsImV4cCI6MjA4Njg4MjMxMH0.bkruo7GrA7UUZIv7HANG4_DFUrm9IygJP9ueVk_4r78';

// On utilise '_spirit' comme tu l'as défini dans ton code de base
const _spirit = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// 2. Fonction de Synchronisation du Ledger (Optimisée et sans erreurs de syntaxe)
async function syncLedger() {
    try {
        console.log("Tentative de synchronisation Spirit Infinity...");
        const { data, error } = await _spirit.from('transactions').select('*');
        
        if (error) throw error;

        if (data) {
            // Calculs basés sur ton Business Model (3€ royalties / 2.5% split)
            let totalRoyalty = data.reduce((s, t) => s + (Number(t.spirit_royalty) || 0), 0);
            let totalPartner = data.reduce((s, t) => s + (Number(t.commission_partner_2_5_percent) || 0), 0);
            let totalSpirit = data.reduce((s, t) => s + (Number(t.commission_spirit_2_5_percent) || 0), 0);
            
            // Mise à jour des éléments HTML que je vois sur tes photos (l-roy, l-part, l-spi)
            if(document.getElementById('l-roy')) document.getElementById('l-roy').innerText = totalRoyalty.toFixed(2) + " €";
            if(document.getElementById('l-part')) document.getElementById('l-part').innerText = totalPartner.toFixed(2) + " €";
            if(document.getElementById('l-spi')) document.getElementById('l-spi').innerText = totalSpirit.toFixed(2) + " €";
            
            console.log("Ledger synchronisé avec succès.");
        }
    } catch (e) {
        console.error("Erreur critique de synchronisation :", e.message);
        if(document.getElementById('l-roy')) document.getElementById('l-roy').innerText = "ERREUR";
    }
}

// 3. Fonction d'achat (Simulateur Marketplace)
async function simulatePayment(price) {
    if(!confirm("Valider l'achat sur la Marketplace Spirit Infinity ?")) return;
    
    const commission = price * 0.025; // Ton split de 2.5%

    const { error } = await _spirit.from('transactions').insert([{ 
        price_sold: price, 
        spirit_royalty: 3.00, // Tes 3€ de royalties par unité
        commission_partner_2_5_percent: commission, 
        commission_spirit_2_5_percent: commission,
        status: 'COMPLETED'
    }]);

    if (error) {
        alert("Erreur lors de la transaction : " + error.message);
    } else {
        alert("Paiement Spirit Validé !");
        syncLedger(); // Mise à jour immédiate du Ledger
    }
}

// 4. Lancement automatique
// Synchronise dès l'ouverture
syncLedger(); 

// Rafraîchissement automatique toutes le 10 secondes pour le "Real-Time"
setInterval(syncLedger, 10000);
